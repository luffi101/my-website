<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Figures Timeline</title>

    <!-- Modern Design CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- PapaParse for CSV import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Firebase Config & Auth -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="timeline-header">
        <div class="header-top">
            <div class="header-title">
                <h1>Historical Figures Timeline</h1>
                <p>Explore history visually across time and regions</p>
            </div>
            <nav class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="journal.html" class="nav-link">Journal</a>
                <a href="timeline.html" class="nav-link active">Timeline</a>
                <a href="admin.html" class="nav-link">Admin</a>
                <a href="old_timeline.html" class="nav-link" style="color: #e67e22; font-weight: bold;">View Classic Timeline</a>
            </nav>
            <!-- Authentication info -->
            <div id="auth-info"></div>
        </div>

        <!-- Search and Controls -->
        <div class="search-controls">
            <div class="search-container">
                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="timeline-search"
                    class="search-input"
                    placeholder="Search historical figures..."
                >
            </div>
            <div class="zoom-controls">
                <button id="zoom-out" class="zoom-btn" title="Zoom Out">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                    </svg>
                </button>
                <span id="zoom-level" class="zoom-level">100%</span>
                <button id="zoom-in" class="zoom-btn" title="Zoom In">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Legend -->
    <div class="legend-container">
        <div class="legend-items">
            <span class="legend-label">Categories:</span>
            <div id="legend-items"></div>
        </div>
    </div>

    <!-- Main Timeline -->
    <main class="timeline-main">
        <div class="timeline-card">
            <!-- Timeline Years Header -->
            <div id="timeline-years" class="timeline-years">
                <!-- Year markers inserted by JavaScript -->
            </div>

            <!-- Timeline Grid -->
            <div id="timeline-grid" class="timeline-grid">
                <!-- Timeline rows inserted by JavaScript -->
            </div>
        </div>
    </main>

    <!-- CSV Import Section (only visible when logged in) -->
    <section id="csv-import-section" class="container hidden">
        <h2>Import CSV Data</h2>
        <form id="csvImportForm">
            <label for="csvDataType">Data Type:</label>
            <select id="csvDataType" name="csvDataType">
                <option value="historicalFigures">Historical Figures</option>
                <option value="globalEvents">Global Events</option>
            </select>
            <br><br>
            <label for="csvFile">CSV File:</label>
            <input type="file" id="csvFile" name="csvFile" accept=".csv" required>
            <br><br>
            <button type="submit">Import CSV</button>
        </form>
        <div id="csvFeedback"></div>
    </section>

    <!-- New Historical Figure Form (only visible when logged in) -->
    <section id="figure-form-section" class="container hidden">
        <h2>Add New Historical Figure</h2>
        <form id="figureForm">
            <div class="form-group">
                <label for="figureName">Name (Lastname, Firstname):</label>
                <input type="text" id="figureName" placeholder="e.g., Franklin, Benjamin" required>
            </div>
            <div class="form-group">
                <label>Categories:</label>
                <div class="checkbox-container">
                    <div class="checkbox-item">
                        <input type="checkbox" id="catPolitics" name="figureCategory" value="Politics &amp; Military">
                        <label for="catPolitics">Politics &amp; Military</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catScience" name="figureCategory" value="Science">
                        <label for="catScience">Science</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catEconomy" name="figureCategory" value="Economy">
                        <label for="catEconomy">Economy</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catArts" name="figureCategory" value="Arts, Musics &amp; Cultural">
                        <label for="catArts">Arts, Musics &amp; Cultural</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catLiterature" name="figureCategory" value="Literature">
                        <label for="catLiterature">Literature</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catPhilosophy" name="figureCategory" value="Philosophy &amp; Religion">
                        <label for="catPhilosophy">Philosophy &amp; Religion</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catSocial" name="figureCategory" value="Social &amp; Cultural Movement">
                        <label for="catSocial">Social &amp; Cultural Movement</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="catExploration" name="figureCategory" value="Exploration &amp; Discovery">
                        <label for="catExploration">Exploration &amp; Discovery</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="figureRegion">Region:</label>
                <select id="figureRegion" required>
                    <option value="">--Select Region--</option>
                    <option value="North America">North America</option>
                    <option value="South America">South America</option>
                    <option value="Europe">Europe</option>
                    <option value="Africa">Africa</option>
                    <option value="Middle East">Middle East</option>
                    <option value="East Asia">East Asia</option>
                    <option value="Australia">Australia</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dateOfBirth">Date of Birth:</label>
                <input type="date" id="dateOfBirth" required>
            </div>
            <div class="form-group">
                <label for="dateOfDeath">Date of Death:</label>
                <input type="date" id="dateOfDeath" required>
            </div>
            <div class="form-group">
                <label for="nationality">Nationality:</label>
                <input type="text" id="nationality">
            </div>
            <div class="form-group">
                <label for="description" style="vertical-align: top;">Description:</label>
                <textarea id="description" rows="3" style="width: 500px;" placeholder="Enter description"></textarea>
            </div>
            <div class="form-group">
                <label for="imageUrl">Image URL:</label>
                <input type="url" id="imageUrl">
            </div>
            <button type="submit">Add Historical Figure</button>
        </form>
        <div id="figureFeedback"></div>
    </section>

    <!-- Enhanced Timeline JavaScript -->
    <script src="timeline-enhanced.js"></script>

    <!-- Firestore Integration -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // Category color mapping (matches your Firestore "groups" field values).
        const categoryColorMap = {
            'politics & military': '#e85d5d',
            'science': '#5a92e8',
            'economy': '#3dbf8e',
            'arts, musics & cultural': '#e066a8',
            'literature': '#f0be42',
            'philosophy & religion': '#9a74e8',
            'social & cultural movement': '#a05820',
            'exploration & discovery': '#14B8A6'
        };

        function getCategoryColor(category) {
            if (!category) return '#6B7280';
            return categoryColorMap[category.trim().toLowerCase()] || '#6B7280';
        }

        // Extract year from a date string like "1706-01-17" or "1706".
        function extractYear(dateStr) {
            if (!dateStr) return null;
            if (dateStr.length === 4) return parseInt(dateStr, 10);
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d.getFullYear();
        }

        // Format name from "Lastname, Firstname" to "Firstname Lastname".
        function formatName(name) {
            if (name && name.includes(',')) {
                const parts = name.split(',');
                if (parts.length >= 2) return parts[1].trim() + ' ' + parts[0].trim();
            }
            return name;
        }

        // Load data from Firestore and initialize the TimelineManager.
        async function loadTimelineData() {
            try {
                // Fetch both collections in parallel.
                const [figuresSnapshot, eventsSnapshot] = await Promise.all([
                    firebase.firestore().collection('historicalFigures').get(),
                    firebase.firestore().collection('globalEvents').get()
                ]);

                // Map Firestore historical figures to the format TimelineManager expects.
                const figures = [];
                let minYear = Infinity;
                let maxYear = -Infinity;

                figuresSnapshot.forEach(doc => {
                    const data = doc.data();
                    const birth = extractYear(data.dateOfBirth);
                    const death = extractYear(data.dateOfDeath);
                    if (!birth || !death) {
                        console.warn('Skipping ' + data.name + ' â€” missing dates.');
                        return;
                    }

                    const category = (data.groups && data.groups.length > 0)
                        ? data.groups[0].trim() : '';

                    const region = data.region || 'Unknown';

                    figures.push({
                        id: doc.id,
                        name: formatName(data.name),
                        birth: birth,
                        death: death,
                        region: region,
                        category: category,
                        color: getCategoryColor(category),
                        description: data.description || '',
                        nationality: data.nationality || ''
                    });

                    if (birth < minYear) minYear = birth;
                    if (death > maxYear) maxYear = death;
                });

                // Map Firestore global events.
                const events = [];
                eventsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const year = extractYear(data.eventDate);
                    if (!year) return;

                    if (year < minYear) minYear = year;
                    if (year > maxYear) maxYear = year;

                    events.push({
                        id: doc.id,
                        name: data.eventName || 'Unknown Event',
                        year: year,
                        description: data.description || '',
                        color: '#F59E0B'
                    });
                });

                // Add padding to the time range.
                if (minYear === Infinity) minYear = 1600;
                if (maxYear === -Infinity) maxYear = 2000;
                minYear = Math.floor(minYear / 10) * 10 - 10;
                maxYear = Math.ceil(maxYear / 10) * 10 + 10;

                // Initialize the TimelineManager with computed time range.
                timelineManager = new TimelineManager({
                    timeRange: { start: minYear, end: maxYear }
                });

                // Load data into the timeline.
                timelineManager.loadFigures(figures);
                timelineManager.loadEvents(events);

                console.log('Timeline loaded: ' + figures.length + ' figures, ' + events.length + ' events.');
            } catch (error) {
                console.error('Error loading timeline data:', error);
            }
        }

        // Start loading data.
        loadTimelineData();

        // Authentication-dependent UI for forms.
        firebase.auth().onAuthStateChanged(user => {
            const figureFormSection = document.getElementById('figure-form-section');
            if (figureFormSection) figureFormSection.classList.toggle('hidden', !user);
            const csvImportSection = document.getElementById('csv-import-section');
            if (csvImportSection) csvImportSection.classList.toggle('hidden', !user);
        });

        // Handle adding a new historical figure.
        const figureForm = document.getElementById('figureForm');
        if (figureForm) {
            figureForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('figureName').value.trim();
                const categoryCheckboxes = document.querySelectorAll('input[name="figureCategory"]:checked');
                const groupsArr = Array.from(categoryCheckboxes).map(cb => cb.value);
                const dateOfBirth = document.getElementById('dateOfBirth').value.trim();
                const dateOfDeath = document.getElementById('dateOfDeath').value.trim();
                const nationality = document.getElementById('nationality').value.trim();
                const description = document.getElementById('description').value.trim();
                const imageUrl = document.getElementById('imageUrl').value.trim();
                const region = document.getElementById('figureRegion').value.trim();

                firebase.firestore().collection('historicalFigures').add({
                    name: name,
                    groups: groupsArr,
                    dateOfBirth: dateOfBirth,
                    dateOfDeath: dateOfDeath,
                    nationality: nationality,
                    description: description,
                    imageUrl: imageUrl,
                    region: region
                }).then(function() {
                    document.getElementById('figureFeedback').innerText = 'Historical figure added successfully!';
                    figureForm.reset();
                    window.location.reload();
                }).catch(function(error) {
                    console.error('Error adding historical figure:', error);
                    document.getElementById('figureFeedback').innerText = 'Error: ' + error.message;
                });
            });
        }

        // CSV Import.
        var csvForm = document.getElementById('csvImportForm');
        if (csvForm) {
            csvForm.addEventListener('submit', function(e) {
                e.preventDefault();
                var fileInput = document.getElementById('csvFile');
                var dataType = document.getElementById('csvDataType').value;
                var file = fileInput.files[0];
                if (!file) {
                    document.getElementById('csvFeedback').innerText = 'Please select a CSV file.';
                    return;
                }

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (dataType === 'historicalFigures') {
                            results.data.forEach(function(row) {
                                var groupsArr = row.groups ? row.groups.split(',').map(function(s) { return s.trim(); }) : [];
                                firebase.firestore().collection('historicalFigures').add({
                                    name: row.name,
                                    dateOfBirth: row.dateOfBirth,
                                    dateOfDeath: row.dateOfDeath,
                                    description: row.description,
                                    groups: groupsArr,
                                    imageURL: row.imageURL,
                                    nationality: row.nationality,
                                    region: row.region || 'unknown'
                                }).then(function() {
                                    console.log('Added: ' + row.name);
                                }).catch(function(error) {
                                    console.error('Error adding figure:', error);
                                });
                            });
                        } else if (dataType === 'globalEvents') {
                            results.data.forEach(function(row) {
                                firebase.firestore().collection('globalEvents').add({
                                    eventName: row.eventName,
                                    eventDate: row.eventDate,
                                    eventEndDate: row.eventEndDate,
                                    description: row.description,
                                    category: row.category,
                                    region: row.region,
                                    significance: row.significance,
                                    createdOn: new Date().toISOString().slice(0, 10)
                                }).then(function() {
                                    console.log('Added event: ' + row.eventName);
                                }).catch(function(error) {
                                    console.error('Error adding event:', error);
                                });
                            });
                        }
                        document.getElementById('csvFeedback').innerText = 'CSV import completed successfully.';
                    },
                    error: function(err) {
                        console.error('Error parsing CSV:', err);
                        document.getElementById('csvFeedback').innerText = 'Error parsing CSV file.';
                    }
                });
            });
        }
    });
    </script>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>

    <footer>
        <p>&copy; <span id="currentYear"></span> Edward C Yang. All rights reserved.</p>
    </footer>
    <script src="common.js"></script>
</body>
</html>
