<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Figures Timeline</title>

    <!-- Modern Design CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config & Auth -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="timeline-header">
        <div class="header-top">
            <div class="header-title">
                <h1>Historical Figures Timeline</h1>
                <p>Explore history visually across time and regions</p>
            </div>
            <nav class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="journal.html" class="nav-link">Journal</a>
                <a href="timeline.html" class="nav-link active">Timeline</a>
                <a href="admin.html" class="nav-link">Admin</a>
                <a href="old_timeline.html" class="nav-link" style="color: #e67e22; font-weight: bold;">View Classic Timeline</a>
            </nav>
            <!-- Authentication info -->
            <div id="auth-info"></div>
        </div>

        <!-- Search and Controls -->
        <div class="search-controls">
            <div class="search-container">
                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="timeline-search"
                    class="search-input"
                    placeholder="Search historical figures..."
                >
            </div>
            <div class="zoom-controls">
                <button id="zoom-out" class="zoom-btn" title="Zoom Out">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                    </svg>
                </button>
                <span id="zoom-level" class="zoom-level">100%</span>
                <button id="zoom-in" class="zoom-btn" title="Zoom In">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Legend -->
    <div class="legend-container">
        <div class="legend-items" id="legend-items"></div>
        <div id="filter-status" class="filter-status"></div>
    </div>

    <!-- Main Timeline -->
    <main class="timeline-main">
        <div class="timeline-card">
            <!-- Viewport Indicator -->
            <div id="viewport-indicator" class="viewport-indicator">
                <span id="viewport-range" class="viewport-range-text"></span>
            </div>

            <!-- Timeline Years Header -->
            <div id="timeline-years" class="timeline-years">
                <!-- Year markers inserted by JavaScript -->
            </div>

            <!-- Timeline Grid -->
            <div id="timeline-grid" class="timeline-grid">
                <!-- Timeline rows inserted by JavaScript -->
            </div>

            <!-- Bottom Time Axis -->
            <div id="timeline-years-bottom" class="timeline-years timeline-years-bottom">
                <!-- Year markers inserted by JavaScript -->
            </div>
            <div id="viewport-indicator-bottom" class="viewport-indicator viewport-indicator-bottom">
                <span id="viewport-range-bottom" class="viewport-range-text"></span>
            </div>
        </div>
    </main>

    <!-- Enhanced Timeline JavaScript -->
    <script src="timeline-enhanced.js"></script>

    <!-- Firestore Integration -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // Category color mapping (matches your Firestore "groups" field values).
        const categoryColorMap = {
            'politics & military': '#EF4444',
            'science': '#3B82F6',
            'economy': '#10B981',
            'visual arts': '#EC4899',
            'music': '#F97316',
            'literature': '#FBBF24',
            'philosophy': '#8B5CF6',
            'religion': '#F59E0B',
            'exploration & discovery': '#14B8A6'
        };

        function getCategoryColor(category) {
            if (!category) return '#6B7280';
            return categoryColorMap[category.trim().toLowerCase()] || '#6B7280';
        }

        // Extract year from a date string like "1706-01-17", "1706", or "-100-07-12".
        function extractYear(dateStr) {
            if (!dateStr) return null;
            const str = dateStr.trim();
            if (str.startsWith('-')) {
                // BC date: "-100-07-12" or "-100"
                const parts = str.substring(1).split('-');
                return -parseInt(parts[0], 10);
            }
            // AD date: "1685-03-31" or "1685"
            const parts = str.split('-');
            return parseInt(parts[0], 10);
        }

        // Format name from "Lastname, Firstname" to "Firstname Lastname".
        function formatName(name) {
            if (name && name.includes(',')) {
                const parts = name.split(',');
                if (parts.length >= 2) return parts[1].trim() + ' ' + parts[0].trim();
            }
            return name;
        }

        // Load data from Firestore and initialize the TimelineManager.
        async function loadTimelineData() {
            try {
                // Fetch both collections in parallel.
                const [figuresSnapshot, eventsSnapshot] = await Promise.all([
                    firebase.firestore().collection('historicalFigures').get(),
                    firebase.firestore().collection('globalEvents').get()
                ]);

                // Map Firestore historical figures to the format TimelineManager expects.
                const figures = [];
                let minYear = Infinity;
                let maxYear = -Infinity;

                figuresSnapshot.forEach(doc => {
                    const data = doc.data();
                    const birth = extractYear(data.dateOfBirth);
                    const death = extractYear(data.dateOfDeath);
                    if (!birth || !death) {
                        console.warn('Skipping ' + data.name + ' â€” missing dates.');
                        return;
                    }

                    const category = (data.groups && data.groups.length > 0)
                        ? data.groups[0].trim() : '';

                    const region = data.region || 'Unknown';

                    figures.push({
                        id: doc.id,
                        name: formatName(data.name),
                        birth: birth,
                        death: death,
                        region: region,
                        category: category,
                        color: getCategoryColor(category),
                        description: data.description || '',
                        nationality: data.nationality || ''
                    });

                    if (birth < minYear) minYear = birth;
                    if (death > maxYear) maxYear = death;
                });

                // Map Firestore global events.
                const events = [];
                eventsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const year = extractYear(data.eventDate);
                    if (!year) return;

                    if (year < minYear) minYear = year;
                    if (year > maxYear) maxYear = year;

                    events.push({
                        id: doc.id,
                        name: data.eventName || 'Unknown Event',
                        year: year,
                        description: data.description || '',
                        color: '#F59E0B'
                    });
                });

                // Add padding to the time range.
                if (minYear === Infinity) minYear = 1600;
                if (maxYear === -Infinity) maxYear = 2000;
                minYear = Math.floor(minYear / 50) * 50 - 50;
                maxYear = Math.ceil(maxYear / 50) * 50 + 50;

                // Initialize the TimelineManager with computed time range.
                timelineManager = new TimelineManager({
                    timeRange: { start: minYear, end: maxYear }
                });

                // Load data into the timeline.
                timelineManager.loadFigures(figures);
                timelineManager.loadEvents(events);

                console.log('Timeline loaded: ' + figures.length + ' figures, ' + events.length + ' events.');
            } catch (error) {
                console.error('Error loading timeline data:', error);
            }
        }

        // Start loading data.
        loadTimelineData();
    });
    </script>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>

    <footer>
        <p>&copy; <span id="currentYear"></span> Edward C Yang. All rights reserved.</p>
    </footer>
    <script src="common.js"></script>
</body>
</html>
